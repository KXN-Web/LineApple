<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【ケーバイエヌ】お問合せフォーム</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
</head>
<body>

    <form class="w-75 mx-auto">
        <p class="mt-3">お名前【必須】</p>
        <div>
            <input id="name" class="form-control w-100 mt-1" name="name" placeholder="" required>
        </div>
        <p class="mt-3">フリガナ【必須】</p>
        <div>
            <input id="furigana" class="form-control w-100 mt-1" name="furigana" required>
        </div>
        <p class="mt-3">電話番号【必須】</p>
        <div>
            <input type="tel" id="phoneNo" class="form-control w-100 mt-1" name="phoneNo" required>
        </div>
        <p class="mt-3">メールアドレス【必須】</p>
        <div>
            <input type="email" id="eMail" class="form-control w-100 mt-1" name="eMail" required>
        </div>
        <p class="mt-3">住所</p>
        <div>
            <input id="jusyo" class="form-control w-100 mt-1" name="jusyo">
        </div>
        <p class="mt-3">最寄り駅</p>
        <div>
            <input id="moyori" class="form-control w-100 mt-1" name="moyori">
        </div>
        <p class="mt-3">最寄り駅からの時間（分）</p>
        <div>
            <input id="moyoriTime" class="form-control w-100 mt-1" name="moyoriTime" >
        </div
        <p class="mt-3">お問合せ内容【必須】</p>
        <div>
            <textarea maxlength="500" rows="5" class="form-control w-100 mt-1" id="naiyo" required></textarea>
        </div>
        <input type="submit" class="mt-4 btn btn-primary" value="送信">
    </form>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        
// ウェブアプリのURL
const endpoint = "https://script.google.com/macros/s/AKfycbyru4-1-tiUc0VjJNHM3Qdm4tUZIFawqo8aRczvzsrm9vpUcqu6410IeG0x-a2pFg8s/exec";

// liff.getContextでユーザー情報オブジェクトをとってくる。（LINEにログインしていることが前提）
const context = liff.getContext()
const lUserId = context.userId

function getSheetData(){
	  
    $.ajax({
        type: 'GET',
        url: endpoint,
        dataType: 'jsonp',
        data: {
            lUserId:lUserId      //LINEUserID
        },
    })
    .done(function(out){
        //受け取ったデータをここで処理する
        console.log(out.data);
        let item = out.data; 
                
        if(item[0] != "データなし"){
			const name    = item[0];
			const furigana = item[1];
			const phoneNo  = item[2];
			const eMail  = item[3];
			const jusyo = item[4];
			const moyori = item[5];
			const moyoriTime = item[6];
			
			// 各要素の取得
			var fname = document.getElementById("name");
			var ffurigana = document.getElementById("furigana");
			var fphoneNo = document.getElementById("phoneNo");
			var feMail = document.getElementById("eMail");
			var fjusyo = document.getElementById("jusyo");
			var fmoyori = document.getElementById("moyori");
			var fmoyoriTime = document.getElementById("moyoriTime");
			
			
			// 各要素の編集
			fname.required = false;
			fname.disabled = true;
			fname.value = name;
			
			ffurigana.required = false;
			ffurigana.disabled = true;
			ffurigana.value = furigana;

			fphoneNo.required = false;
			fphoneNo.disabled = true;
			fphoneNo.value = phoneNo;

			feMail.required = false;
			feMail.disabled = true;
			feMail.value = eMail;

			fjusyo.required = false;
			fjusyo.disabled = true;
			fjusyo.value = jusyo;

			fmoyori.required = false;
			fmoyori.disabled = true;
			fmoyori.value = moyori;

			fmoyoriTime.required = false;
			fmoyoriTime.disabled = true;
			fmoyoriTime.value = moyoriTime;

        }

    })
    .fail(function() {
        //エラー時の処理を書く
        console.log('エラー');
    })
    
}
        $(document).ready(function () {
            const liffId = "1660996109-5XePRDqM";
            initializeLiff(liffId);
        })

        function initializeLiff(liffId) {
            liff.init({
                liffId: liffId
            }).then(() => {
                initializeApp();
            }).catch((err) => {
                console.log('LIFF Initialization failed ', err);
            });
        }

        function sendText(text) {
            liff.sendMessages([{
                'type': 'text',
                'text': text
            }]).then(function () {
                liff.closeWindow();
            }).catch(function (error) {
                window.alert('Failed to send message ' + error);
            });
        }

        const params = (new URL(document.location)).searchParams;
        const key = params.get('key');

        $(function () {
            $('form').submit(function () {
                const flg     = "【お問合せ】";
                const name    = $('input[name="name"]').val();
                const furigana = $('input[name="furigana"]').val();
                const phoneNo  = $('input[name="phoneNo"]').val();
                const eMail  = $('input[name="eMail"]').val();
                const jusyo = $('input[name="jusyo"]').val();
                const moyori = $('input[name="moyori"]').val();
                const moyoriTime = $('input[name="moyoriTime"]').val();
                const naiyo = (document.getElementById("naiyo").value).replace( /\r?\n/g , ' ');
                const msg = `${flg}\n${name}\n${furigana}\n${phoneNo}\n${eMail}\n${jusyo}\n${moyori}\n${moyoriTime}\n${naiyo}`;
                sendText(msg);
                return false;
            });
        });

    </script>

</body>
</html>
